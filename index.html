<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>US Census ACS Data Explorer | Interactive Map</title>
    <meta name="description" content="Interactive map showing US Census data on education and income by ZIP code">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">
    
    <!-- CSS -->
    <link rel="stylesheet" href="css/styles.css">
    
    <!-- Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap">
    
    <!-- Configuration -->
    <script src="config.js"></script>
    
    <!-- Dynamically load Google Maps with API key -->
    <script>
        // Load Google Maps after config is loaded
        function loadGoogleMaps() {
            if (!window.CONFIG || !window.CONFIG.GOOGLE_MAPS_API_KEY) {
                document.addEventListener('DOMContentLoaded', function() {
                    const errorDiv = document.getElementById('error-container');
                    if (errorDiv) {
                        errorDiv.innerHTML = `
                            <div class="error-message">
                                <h3>‚ö†Ô∏è Configuration Error</h3>
                                <p>Please configure your Google Maps API key in config.js</p>
                                <p>Make sure the key is restricted to your domain.</p>
                            </div>
                        `;
                        errorDiv.style.display = 'block';
                    }
                });
                return;
            }
            
            // Load Google Maps with configured key
            const googleMapsScript = document.createElement('script');
            googleMapsScript.src = `https://maps.googleapis.com/maps/api/js?key=${CONFIG.GOOGLE_MAPS_API_KEY}&callback=initApp&loading=async&libraries=marker`;
            googleMapsScript.async = true;
            googleMapsScript.defer = true;
            document.head.appendChild(googleMapsScript);
        }
        
        // Start loading after config
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadGoogleMaps);
        } else {
            loadGoogleMaps();
        }
    </script>
    
    <!-- MarkerClusterer Library -->
    <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <h3>Loading Census Data Map</h3>
            <p id="loading-text">Initializing application...</p>
            <div class="progress-container">
                <div id="loading-progress" class="progress-bar"></div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <h1>üá∫üá∏ US Census ACS Data Explorer</h1>
            <p class="subtitle">Interactive visualization of education and income data by ZIP Code</p>
        </div>
        <div class="header-actions">
            <button id="fullscreen-btn" class="btn-icon" title="Fullscreen">
                <span>‚õ∂</span>
            </button>
            <button id="help-btn" class="btn-icon" title="Help">
                <span>?</span>
            </button>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <!-- Data Source Info -->
            <div class="info-card">
                <h3>üìä Data Sources</h3>
                <p><strong>US Census ACS 2022</strong> 5-Year Estimates</p>
                <ul class="data-sources">
                    <li>üéì <strong>Education:</strong> Bachelor's degree or higher</li>
                    <li>üí∞ <strong>Income:</strong> Households ‚â• $100k/year</li>
                </ul>
                <p class="disclaimer">Each pin ‚âà 1,000 residents/households</p>
            </div>

            <!-- Layer Controls -->
            <div class="control-card">
                <h3>üéõÔ∏è Map Layers</h3>
                
                <div class="layer-control">
                    <label class="layer-toggle">
                        <input type="checkbox" id="toggle-education" checked>
                        <span class="toggle-slider"></span>
                        <span class="toggle-label">
                            <span class="icon">üéì</span>
                            Education Layer
                        </span>
                    </label>
                    <p class="layer-description">Residents age 25+ with Bachelor's degree or higher</p>
                    <div class="layer-stats" id="stats-education">Loading...</div>
                </div>

                <div class="layer-control">
                    <label class="layer-toggle">
                        <input type="checkbox" id="toggle-income" checked>
                        <span class="toggle-slider"></span>
                        <span class="toggle-label">
                            <span class="icon">üí∞</span>
                            Income Layer
                        </span>
                    </label>
                    <p class="layer-description">Households with income ‚â• $100,000/year</p>
                    <div class="layer-stats" id="stats-income">Loading...</div>
                </div>

                <!-- Legend -->
                <div class="legend">
                    <h4>Map Legend</h4>
                    <div class="legend-item">
                        <span class="legend-color" style="background-color: #1a73e8;"></span>
                        <span>Education (Bachelor's+)</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background-color: #34a853;"></span>
                        <span>Income (‚â• $100k)</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-cluster">‚è∫‚è∫‚è∫</span>
                        <span>Marker Cluster</span>
                    </div>
                </div>
            </div>

            <!-- Map Controls -->
            <div class="control-card">
                <h3>üó∫Ô∏è Map Controls</h3>
                <div class="button-group">
                    <button id="reset-view" class="btn-secondary">
                        <span>‚Ü∫</span> Reset View
                    </button>
                    <button id="clear-markers" class="btn-secondary">
                        <span>√ó</span> Clear Markers
                    </button>
                </div>
                <div class="zoom-info">
                    <label>Current Zoom: <span id="zoom-level">4</span></label>
                    <input type="range" id="zoom-slider" min="1" max="18" value="4">
                </div>
            </div>

            <!-- Data Summary -->
            <div class="stats-card">
                <h3>üìà Data Summary</h3>
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="summary-value" id="total-zips">0</div>
                        <div class="summary-label">ZIP Codes</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value" id="total-pins">0</div>
                        <div class="summary-label">Total Pins</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value" id="education-total">0</div>
                        <div class="summary-label">Educated Residents</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value" id="income-total">0</div>
                        <div class="summary-label">High-Income Households</div>
                    </div>
                </div>
                <div class="timestamp" id="data-timestamp">
                    Last updated: <span id="update-time">Never</span>
                </div>
            </div>

            <!-- Help Section -->
            <div class="help-card">
                <h3>‚ùì How to Use</h3>
                <ol class="help-steps">
                    <li>Toggle layers using the switches</li>
                    <li>Click on pins to see detailed data</li>
                    <li>Zoom in to separate clustered markers</li>
                    <li>Use slider to control zoom level</li>
                </ol>
                <p class="source-note">
                    <strong>Source:</strong> US Census Bureau ACS 2022
                </p>
            </div>
        </aside>

        <!-- Main Map Area -->
        <main class="main-content">
            <div class="map-container">
                <div id="map"></div>
                <div class="map-controls">
                    <button id="zoom-in" class="map-btn">+</button>
                    <button id="zoom-out" class="map-btn">-</button>
                </div>
                <div class="map-coordinates">
                    Lat: <span id="lat-coord">0.0000</span>, 
                    Lng: <span id="lng-coord">0.0000</span>
                </div>
            </div>
            
            <!-- Error Display -->
            <div id="error-container" class="error-container" style="display: none;"></div>
        </main>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <p>
                <strong>US Census ACS Data Explorer</strong> | 
                Created with data from the US Census Bureau | 
                Not an official government product
            </p>
            <p class="footer-links">
                <a href="https://www.census.gov/data/developers/data-sets/acs-5year.html" target="_blank">Data Source</a> | 
                <a href="https://github.com" target="_blank">GitHub</a>
            </p>
        </div>
    </footer>

    <!-- JavaScript Files -->
    <script src="js/app.js"></script>
    
    <!-- Initialize application -->
    <script>
        window.app = null;
        
        window.initApp = function() {
            console.log('Google Maps loaded, initializing application...');
            window.app = new CensusMapApp();
            window.app.initialize();
        };
        
        // Fallback if Google Maps fails to load
        setTimeout(function() {
            if (!window.google || !window.google.maps) {
                const loadingOverlay = document.getElementById('loading-overlay');
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'none';
                }
                
                const errorDiv = document.getElementById('error-container');
                if (errorDiv) {
                    errorDiv.innerHTML = `
                        <div class="error-message">
                            <h3>‚ùå Failed to load Google Maps</h3>
                            <p>Please check your API key configuration in config.js</p>
                            <p>Make sure the key is valid and has the Maps JavaScript API enabled.</p>
                        </div>
                    `;
                    errorDiv.style.display = 'block';
                }
            }
        }, 15000); // 15 second timeout
    </script>
</body>
</html>