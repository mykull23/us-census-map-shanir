name: Deploy to GitHub Pages

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

# Set permissions for GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Create secure config file
        run: |
          echo "ðŸ› ï¸ Creating secure configuration file..."
          
          # Remove any existing config files to avoid confusion
          rm -f js/config.js js/config-public.js
          
          # Create the secure config with API key from secrets
          cat > js/config.js << 'EOF'
          // ============================================
          // AUTO-GENERATED CONFIG FOR GITHUB PAGES
          // Generated during deployment - DO NOT MODIFY
          // ============================================
          
          // Environment detection
          const IS_LOCAL = window.location.hostname === 'localhost' || 
                          window.location.hostname === '127.0.0.1';
          const IS_GITHUB = window.location.hostname.includes('github.io');
          
          // Configuration object
          const CONFIG = {
              // Google Maps API Key (injected from GitHub Secrets)
              GOOGLE_MAPS_API_KEY: '${{ secrets.GOOGLE_MAPS_API_KEY }}',
              
              // Environment info
              ENVIRONMENT: IS_GITHUB ? 'production' : 'development',
              IS_LOCAL: IS_LOCAL,
              IS_GITHUB: IS_GITHUB,
              
              // Census API settings
              CENSUS_API_BASE: 'https://api.census.gov/data',
              CENSUS_YEAR: '2022',
              CENSUS_SURVEY: 'acs/acs5',
              
              // Application settings
              MAX_ZIP_CODES: 500,
              PIN_THRESHOLD: 1000,
              DEBUG_MODE: IS_GITHUB ? false : true,
              
              // Build info (for debugging)
              BUILD_ID: '${{ github.run_id }}',
              BUILD_NUMBER: '${{ github.run_number }}',
              BUILD_DATE: new Date().toISOString().split('T')[0]
          };
          
          // Safe logging (no key exposure)
          if (CONFIG.DEBUG_MODE) {
              console.log('ðŸ”§ Census Map Configuration:', {
                  environment: CONFIG.ENVIRONMENT,
                  buildId: CONFIG.BUILD_ID,
                  hasApiKey: !!CONFIG.GOOGLE_MAPS_API_KEY,
                  keyPreview: CONFIG.GOOGLE_MAPS_API_KEY ? 
                    CONFIG.GOOGLE_MAPS_API_KEY.substring(0, 6) + '...' + 
                    CONFIG.GOOGLE_MAPS_API_KEY.substring(CONFIG.GOOGLE_MAPS_API_KEY.length - 4) : 'MISSING'
              });
          }
          
          // Make config globally available
          window.CONFIG = CONFIG;
          EOF
          
          echo "âœ… Config file created"
          echo "ðŸ“ File size:" $(wc -l < js/config.js) "lines"
          echo "ðŸ” First 3 lines:"
          head -3 js/config.js

      - name: Verify file structure
        run: |
          echo "ðŸ“‚ Verifying project structure..."
          ls -la
          echo "---"
          ls -la js/ || echo "js directory not found"
          echo "---"
          echo "ðŸ“„ Checking index.html references..."
          grep -n "config.js" index.html || echo "config.js not referenced in index.html"

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4